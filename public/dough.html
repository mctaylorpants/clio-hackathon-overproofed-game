<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.23.0/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>
  <p><a href="index.html">< back</a></p>
  <hr />
  <style>
    @font-face {
      font-family: "AmaticSC-Regular";
      src: url("assets/fonts/AmaticSC-Regular.ttf") format("truetype");
    }

    @font-face {
      font-family: "AmaticSC-Bold";
      src: url("assets/fonts/AmaticSC-Bold.ttf") format("truetype");
    }
  </style>
  <!-- HACK TO LOAD THE FONT -->
  <div style="font-family:'AmaticSC-Bold'; position:absolute; left:-1000px; visibility:hidden;">.</div>

    <script>
    var config = {
    type: Phaser.AUTO,

    parent: 'game',
    width: 960,
    height: 540,

    physics: {
      default: 'arcade',
      arcade: {
        gravity: { y: 150 },
        debug: false,
      }
    },
    scene: {
      preload: preload,
      create: create,
      update: update,
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
      //add sounds
      this.load.audio('pour_flour', 'assets/pour_flour.mp3');
      this.load.audio('pour_water', 'assets/pour_water.mp3');

      //add images
      this.load.image('background', 'assets/background.jpg');
      this.load.image('ground', 'assets/platform.png');
      this.load.image('dough-xs', 'assets/dough-xs.png');
      this.load.image('water-button', 'assets/container_water.png');
      this.load.image('flour-button', 'assets/flour.png');
      this.load.image('next-button', 'assets/right_sourdough_arrow.png');
      this.load.spritesheet('water',
        'assets/water-small.png',
        { frameWidth: 100, frameHeight: 100 }
      );
      this.load.spritesheet('flour',
        'assets/flour-sprinkle.png',
        { frameWidth: 200, frameHeight: 200 }
      );

      this.load.script('webfont', 'https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js');
    }

    var platforms;

    var interval;
    var scoreWater = 0;
    var scoreTextWater;
    var scoreFlour = 0;
    var scoreTextFlour;
    var dough;
    var soundWater;
    var soundFlour;
    var buttonNext;

    function create ()
    {
      WebFont.load({
        custom: {
          families: ['AmaticSC-Regular', 'AmaticSC-Bold']
        }
      });

      platforms = this.physics.add.staticGroup();
      platforms.create(420, 410, 'ground').setScale(2).refreshBody();
      this.add.image(480, 270, 'background').setDisplaySize(960, 540);
      buttonNext = this.add.image(910, 495, 'next-button').setScale(0.07);
      buttonNext.setInteractive().on('pointerup', function () {
        window.location.href = '/stage_three.html';
      });
      buttonNext.visible = false;
      showNextButton(8000);
      dough = this.add.image(500, 330, 'dough-xs').setDisplaySize(400, 300)
      initializeDough();
    }

    function showNextButton(timeDelay) {
      intervalButton = setInterval(function() {
        buttonNext.visible = true;
      }, timeDelay);
    }

    function initializeDough() {
      initializeWater();
      initializeFlour();
    }

    function initializeWater() {
      this.soundWater = game.sound.add('pour_water');
      scoreTextWater = game.scene.scenes[0].add.text(16, 150, 'Water: 0g/1000g', { fontFamily: 'AmaticSC-Bold', fontSize: '32px', fill: '#c3884c' });
      const waterButton = game.scene.scenes[0].add.image(100, 400, 'water-button').setScale(2.0);

      waterButton.setInteractive();
      waterButton.on('pointerdown', onPointerDownWater);
      waterButton.on('pointerup', onPointerUp);
      waterButton.on('pointerout', onPointerOut);
    }

    function initializeFlour() {
      this.soundFlour = game.sound.add('pour_flour');
      scoreTextFlour = game.scene.scenes[0].add.text(675, 150, 'Flour: 0g/1000g', { fontFamily: 'AmaticSC-Bold', fontSize: '32px', fill: '#c3884c' });
      const flourButton = game.scene.scenes[0].add.image(900, 380, 'flour-button').setScale(1.50);

      flourButton.setInteractive();
      flourButton.on('pointerdown', onPointerDownFlour);
      flourButton.on('pointerup', onPointerUp);
      flourButton.on('pointerout', onPointerOut);
    }

    function playSound(itemToPlay, itemScore, threshold) {
      (itemScore < threshold) ? itemToPlay.play(): null;
    }

    function onPointerDownWater() {
      playSound(game.sound.sounds[0], scoreWater, 1000);
      interval = setInterval(function() {
        addWater();
      }, 5);
    }

    function onPointerDownFlour() {
      playSound(game.sound.sounds[1], scoreFlour, 1000);
      interval = setInterval(function() {
        addFlour();
      }, 5);
    }

    function onPointerUp() {
      clearInterval(interval);
      game.sound.sounds[0].stop();
      game.sound.sounds[1].stop();
    }

    function onPointerOut() {
      clearInterval(interval);
      game.sound.sounds[0].stop();
      game.sound.sounds[1].stop();
    }

    function addWater() {
      console.log("Button clicked. scoreWater: " + scoreWater);
      if (scoreWater < 1000) {
        scoreWater += 1;
        tester = game.scene.scenes[0].physics.add.sprite(500, 0, 'water');
        game.scene.scenes[0].physics.add.collider(tester, platforms);
        scoreTextWater.setText('Water: ' + scoreWater + 'g/1000g');
      }
      else {
        this.onPointerOut();
      }
    }

    function addFlour() {
      console.log("Button clicked. scoreFlour: " + scoreFlour);
      if (scoreFlour < 1000) {
        scoreFlour += 1;
        tester = game.scene.scenes[0].physics.add.sprite(500, 0, 'flour');
        game.scene.scenes[0].physics.add.collider(tester, platforms);
        scoreTextFlour.setText('Flour: ' + scoreFlour + 'g/1000g');
      }
      else {
        this.onPointerOut();
      }
    }

    function update ()
    {
      var combinedTotal = scoreFlour + scoreWater;
      if (combinedTotal > 300 && combinedTotal <= 600) {
        dough.setDisplaySize(500, 375);
      } else if (combinedTotal > 600 && combinedTotal <= 900) {
        dough.setDisplaySize(600, 450);
      } else if (combinedTotal > 900 && combinedTotal <= 1200) {
        dough.setDisplaySize(700, 525);
      } else if (combinedTotal > 1200 && combinedTotal <= 1500) {
        dough.setDisplaySize(800, 600);
      } else if (combinedTotal > 1500 && combinedTotal <= 1900) {
        dough.setDisplaySize(900, 675);
      } else if (combinedTotal > 1900 || scoreFlour > 1050 || scoreWater > 850) {
        dough.setDisplaySize(600, 450);
      }
    }

    </script>
  <div id="container" style="display: flex;flex-direction: column;align-items: center;margin-top: 20px">
    <div id="ui" style="margin-bottom: 20px; width:960px; display: flex; justify-content: left">
      <div>
        <a href="index.html">
          <img src="assets/back.png" width="60" />
        </a>
      </div>
      <div>
        <img src="assets/title/create_dough_title.png" width="590"/>
      </div>
    </div>
    <div id="game">
    </div>
</body>
</html>
